<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <title>Read-meter | Home</title>
  <base href="/Read-meter/">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap สำหรับ layout/card/table ที่เดิมอยู่ใน base.html -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body{font-family:system-ui,Segoe UI,Arial}
    .container-narrow{max-width:1280px}
    .kpi-row .card { border: none; color:#fff; }
    .kpi-row .card .value { font-size: 1.6rem; font-weight: 800; line-height: 1; }
    .kpi-row .card .label { opacity:.9; font-size:.9rem; }
    .kpi-blue   { background:#1e63ff; }
    .kpi-green  { background:#168a4a; }
    .kpi-red    { background:#cb2444; }
    .kpi-amber  { background:#f29f05; color:#1a1a1a; }
    .kpi-cyan   { background:#09a9c3; }
    .kpi-gray   { background:#5b6470; }
    .card-compact { padding: .75rem 1rem; }
    .card-compact h6 { margin:0 0 .25rem; font-size:.95rem; font-weight:700; }
    .chart-wrap { height: 220px; }
    .table-fixed { max-height: 280px; overflow:auto; }
    .form-inline { gap:.5rem; display:flex; align-items:center; justify-content:flex-end; }
    .badge-src { font-size:.75rem; }
  </style>
</head>
<body>
  <div class="container container-narrow py-3">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h3 class="mb-0">Energy Dashboard</h3>
      <div class="form-inline">
        <select id="yearSelect" class="form-select form-select-sm" style="width:auto"></select>
        <select id="monthSelect" class="form-select form-select-sm" style="width:auto">
          <option value="01">01</option><option value="02">02</option><option value="03">03</option>
          <option value="04">04</option><option value="05">05</option><option value="06">06</option>
          <option value="07">07</option><option value="08">08</option><option value="09">09</option>
          <option value="10">10</option><option value="11">11</option><option value="12">12</option>
        </select>
        <button id="applyBtn" class="btn btn-sm btn-primary">Filter</button>
      </div>
    </div>

    <div class="row g-3 kpi-row mb-2">
      <div class="col-6 col-md-4 col-lg-2"><div class="card kpi-blue h-100"><div class="card-body py-3">
        <div class="label">Voltage (V)</div><div id="kpiV" class="value">0</div></div></div></div>
      <div class="col-6 col-md-4 col-lg-2"><div class="card kpi-green h-100"><div class="card-body py-3">
        <div class="label">Current (A)</div><div id="kpiI" class="value">0</div></div></div></div>
      <div class="col-6 col-md-4 col-lg-2"><div class="card kpi-red h-100"><div class="card-body py-3">
        <div class="label">Power (W)</div><div id="kpiP" class="value">0</div></div></div></div>
      <div class="col-6 col-md-4 col-lg-2"><div class="card kpi-amber h-100"><div class="card-body py-3">
        <div class="label">Energy (kWh)</div><div id="kpiE" class="value">0</div></div></div></div>
      <div class="col-6 col-md-4 col-lg-2"><div class="card kpi-cyan h-100"><div class="card-body py-3">
        <div class="label">Frequency (Hz)</div><div id="kpiHz" class="value">0</div></div></div></div>
      <div class="col-6 col-md-4 col-lg-2"><div class="card kpi-gray h-100"><div class="card-body py-3">
        <div class="label">PF</div><div id="kpiPF" class="value">0</div></div></div></div>
    </div>

    <p class="mb-2"><span class="badge bg-secondary badge-src">
      Static demo on GitHub Pages — จะใช้ mock data อัตโนมัติเมื่อไม่มี backend
    </span></p>

    <div class="row g-3">
      <div class="col-lg-4"><div class="card card-compact h-100">
        <h6>Voltage — Line</h6><div class="chart-wrap"><canvas id="chartV"></canvas></div></div></div>
      <div class="col-lg-4"><div class="card card-compact h-100">
        <h6>Current — Bar</h6><div class="chart-wrap"><canvas id="chartI"></canvas></div></div></div>
      <div class="col-lg-4"><div class="card card-compact h-100">
        <h6>Power — Bar</h6><div class="chart-wrap"><canvas id="chartP"></canvas></div></div></div>
      <div class="col-lg-4"><div class="card card-compact h-100">
        <h6>Energy (kWh) — Bar</h6><div class="chart-wrap"><canvas id="chartE"></canvas></div></div></div>
      <div class="col-lg-4"><div class="card card-compact h-100">
        <h6>Frequency — Line</h6><div class="chart-wrap"><canvas id="chartHz"></canvas></div></div></div>
      <div class="col-lg-4"><div class="card card-compact h-100">
        <h6>Power Factor — Gauge</h6><div class="chart-wrap"><canvas id="chartPF"></canvas></div></div></div>
    </div>

    <div class="card mt-3">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <h6 class="mb-2">Raw Data (ทั้งหมด)</h6>
          <small class="text-muted">อัปเดตทุก 5 วินาที</small>
        </div>
        <div class="table-responsive table-fixed">
          <table class="table table-sm align-middle mb-0">
            <thead class="table-light"><tr>
              <th>Time (TH)</th><th>V</th><th>A</th><th>W</th><th>kWh</th><th>Hz</th><th>PF</th>
            </tr></thead>
            <tbody id="rawBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Vendor libs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
  <script src="https://cdn.jsdelivr.net/npm/moment@2.30.1/min/moment.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/moment-timezone@0.5.45/builds/moment-timezone-with-data.min.js"></script>

  <script>
  // ========= Config =========
  const TH_TZ = "Asia/Bangkok";
  // ถ้ามี backend จริง ให้ใส่ URL เช่น "https://read-meter.onrender.com"
  const BACKEND_BASE = "";  // ว่าง = ใช้ relative (/api/..), Pages จะ fail แล้ว fallback เป็น mock

  const thDayLabel = iso => moment.tz(iso, TH_TZ).format("YYYY-MM-DD");
  const thDateTime = iso => moment.tz(iso, TH_TZ).format("YYYY-MM-DD HH:mm:ss");

  function firstOfEachDayForMonth(rows, year, month) {
    const y = String(year), m = String(month).padStart(2,"0");
    const seen = new Set(), out = [];
    for (const r of rows) {
      const day = thDayLabel(r.ts);
      if (!day.startsWith(`${y}-${m}`)) continue;
      if (seen.has(day)) continue;
      seen.add(day);
      out.push({...r, day});
    }
    out.sort((a,b) => a.day.localeCompare(b.day));
    return out;
  }

  (function initYearMonth() {
    const now = moment.tz(TH_TZ);
    const ySel = document.getElementById('yearSelect');
    for (let y = now.year() - 3; y <= now.year()+1; y++) {
      const opt = document.createElement('option');
      opt.value = String(y); opt.textContent = y;
      if (y === now.year()) opt.selected = true;
      ySel.appendChild(opt);
    }
    document.getElementById('monthSelect').value = now.format("MM");
  })();

  // ===== Mock data (ใช้เมื่อ fetch /api ล้มเหลว) =====
  function makeMockRows() {
    const now = moment.tz(TH_TZ);
    const start = now.clone().startOf('month');
    const rows = [];
    let energy = 1200 + Math.random()*80;
    for (let d=0; d<now.date(); d++) {
      const day = start.clone().add(d, 'days');
      // สุ่ม 8 แถวต่อวัน
      for (let i=0;i<8;i++) {
        const ts = day.clone().add(i*3, 'hours').toISOString();
        const voltage = 218 + Math.random()*12;
        const current = 5 + Math.random()*7;
        const power = voltage * current * (0.7 + Math.random()*0.25);
        energy += power/1000 * 0.1; // สะสมค่อยๆ
        const frequency = 49.7 + Math.random()*0.7;
        const pf = 0.7 + Math.random()*0.25;
        rows.push({ts, voltage:+voltage.toFixed(1), current:+current.toFixed(2),
                   power:+power.toFixed(0), energy_kwh:+energy.toFixed(2),
                   frequency:+frequency.toFixed(2), pf:+pf.toFixed(2)});
      }
    }
    return rows;
  }
  const MOCK_ROWS = makeMockRows();

  async function fetchJSON(path) {
    const url = (BACKEND_BASE ? BACKEND_BASE : "") + path;
    const r = await fetch(url, {cache:'no-store'});
    if (!r.ok) throw new Error("HTTP "+r.status);
    return await r.json();
  }

  async function refreshLatest() {
    try {
      const d = await fetchJSON('/api/realtime');
      const zerofy = (x) => (typeof x === 'number' && isFinite(x) ? x : 0);
      document.getElementById('kpiV').textContent  = zerofy(d.voltage);
      document.getElementById('kpiI').textContent  = zerofy(d.current);
      document.getElementById('kpiP').textContent  = zerofy(d.power);
      document.getElementById('kpiE').textContent  = zerofy(d.energy_kwh);
      document.getElementById('kpiHz').textContent = zerofy(d.frequency);
      document.getElementById('kpiPF').textContent = zerofy(d.pf);
    } catch(e) {
      // ใช้สุดท้ายของ mock
      const d = MOCK_ROWS[MOCK_ROWS.length-1] || {};
      document.getElementById('kpiV').textContent  = d.voltage ?? 0;
      document.getElementById('kpiI').textContent  = d.current ?? 0;
      document.getElementById('kpiP').textContent  = d.power ?? 0;
      document.getElementById('kpiE').textContent  = d.energy_kwh ?? 0;
      document.getElementById('kpiHz').textContent = d.frequency ?? 0;
      document.getElementById('kpiPF').textContent = d.pf ?? 0;
    }
  }

  async function refreshRaw() {
    const body = document.getElementById('rawBody');
    try {
      const rows = await fetchJSON('/api/history?n=300');
      body.innerHTML = '';
      rows.slice().reverse().forEach(x => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${thDateTime(x.ts)}</td>
          <td>${x.voltage ?? ''}</td>
          <td>${x.current ?? ''}</td>
          <td>${x.power ?? ''}</td>
          <td>${x.energy_kwh ?? ''}</td>
          <td>${x.frequency ?? ''}</td>
          <td>${x.pf ?? ''}</td>`;
        body.appendChild(tr);
      });
    } catch(e) {
      // ใช้ mock
      body.innerHTML = '';
      MOCK_ROWS.slice(-300).reverse().forEach(x => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${thDateTime(x.ts)}</td>
          <td>${x.voltage}</td>
          <td>${x.current}</td>
          <td>${x.power}</td>
          <td>${x.energy_kwh}</td>
          <td>${x.frequency}</td>
          <td>${x.pf}</td>`;
        body.appendChild(tr);
      });
    }
  }

  let chV, chI, chP, chE, chHz, chPF;
  function lineCfg(label) {
    return { type:'line', data:{labels:[], datasets:[{label, data:[], tension:.3}]},
      options:{responsive:true, maintainAspectRatio:false,
        scales:{x:{ticks:{autoSkip:true, maxTicksLimit:8}}} } };
  }
  function barCfg(label) {
    return { type:'bar', data:{labels:[], datasets:[{label, data:[]}]},
      options:{responsive:true, maintainAspectRatio:false,
        scales:{x:{ticks:{autoSkip:true, maxTicksLimit:8}}} } };
  }
  function gaugeCfg() {
    return { type:'doughnut',
      data:{labels:['PF',''], datasets:[{data:[0,1], cutout:'70%'}]},
      options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}} };
  }

  function initCharts() {
    chV  = new Chart(document.getElementById('chartV'),  lineCfg('Voltage (V)'));
    chI  = new Chart(document.getElementById('chartI'),  barCfg('Current (A)'));
    chP  = new Chart(document.getElementById('chartP'),  barCfg('Power (W)'));
    chE  = new Chart(document.getElementById('chartE'),  barCfg('Energy (kWh)'));
    chHz = new Chart(document.getElementById('chartHz'), lineCfg('Frequency (Hz)'));
    chPF = new Chart(document.getElementById('chartPF'), gaugeCfg());
  }

  async function getAllRows() {
    try { return await fetchJSON('/api/history?n=5000'); }
    catch { return MOCK_ROWS; }
  }

  async function loadMonth() {
    const year  = document.getElementById('yearSelect').value;
    const month = document.getElementById('monthSelect').value;
    const rows = await getAllRows();

    const days = firstOfEachDayForMonth(rows, year, month);
    const labels = days.map(d => d.day);
    const nz = (x) => (x === null || x === undefined) ? null : x;

    chV.data.labels=labels;   chV.data.datasets[0].data = days.map(d=>nz(d.voltage));     chV.update();
    chI.data.labels=labels;   chI.data.datasets[0].data = days.map(d=>nz(d.current));     chI.update();
    chP.data.labels=labels;   chP.data.datasets[0].data = days.map(d=>nz(d.power));       chP.update();
    chE.data.labels=labels;   chE.data.datasets[0].data = days.map(d=>nz(d.energy_kwh));  chE.update();
    chHz.data.labels=labels;  chHz.data.datasets[0].data = days.map(d=>nz(d.frequency));  chHz.update();

    // PF gauge: clamp 0..1
    let pf = 0;
    if (days.length) {
      const v = days[days.length-1].pf;
      pf = (typeof v === 'number' && isFinite(v)) ? Math.max(0, Math.min(1, v)) : 0;
    }
    chPF.data.datasets[0].data = [pf, 1 - pf];
    chPF.update();
  }

  // Boot
  initCharts();
  loadMonth();
  refreshLatest();
  refreshRaw();
  setInterval(refreshLatest, 2000);
  setInterval(refreshRaw,   5000);
  document.getElementById('applyBtn').addEventListener('click', loadMonth);
  </script>
</body>
</html>
